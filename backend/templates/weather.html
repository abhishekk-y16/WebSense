<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weather Forecast - WebSense</title>
  <link rel="stylesheet" href="../../frontend/style.css">
  <link rel="stylesheet" href="../../frontend/pages.css">
  <link rel="stylesheet" href="../../frontend/weather.css">
</head>
<body class="light-theme">

  <main class="container">
   <h1 id="page-title" class="page-title">Current Weather</h1>

    <div class="search-bar" style="max-width:640px; margin:0 auto 6px; position:relative;">
      <div style="display:flex; gap:8px;">
        <input id="city-input" class="search-input" type="text" placeholder="Search city, town or village (e.g. Mumbai)" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,0.06);" autocomplete="off" />
        <button id="city-search" class="button btn-search">Search</button>
        <button id="city-clear" class="button btn-clear">Clear</button>
      </div>
      <div id="suggestions" class="suggestions" style="display:none; position:absolute; left:0; right:0; top:54px; z-index:80;"></div>
    </div>

    <div id="weather-container" class="card-grid"></div>
  </main>

  <footer>
    <p>&copy; 2025 WebSense | All Rights Reserved.</p>
  </footer>

  <script>
    // Helper to get full country name from ISO code (fallback to code)
    const regionNames = (typeof Intl !== 'undefined' && Intl.DisplayNames) ? new Intl.DisplayNames(['en'], { type: 'region' }) : null;
    function getCountryName(code) {
      if (!code) return '';
      try { return regionNames ? (regionNames.of(code) || code) : code; } catch (e) { return code; }
    }

    async function fetchWeather(query) {
      const topCities = [
        'New York', 'London', 'Paris', 'Tokyo', 'Sydney', 'Berlin',
        'Los Angeles', 'Rome', 'Barcelona', 'Dubai', 'Istanbul', 'Mumbai',
        'Mexico City', 'Cairo', 'Rio de Janeiro'
      ];

      const container = document.getElementById('weather-container');
      container.innerHTML = ''; // Clear previous results

      // If a query is provided, try to fetch that city only
      const citiesToFetch = query && query.trim().length > 0 ? [query.trim()] : topCities;

      try {
        for (let city of citiesToFetch) {
          // First try direct city name lookup
          let response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=c95c4b4e192d129bb946d83057181005&units=metric`);
          let data = await response.json();

          // If direct lookup fails for a single query (like a small village), try geocoding fallback
          if ((!data || data.cod !== 200) && citiesToFetch.length === 1) {
            try {
              const geoResp = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(city)}&limit=1&appid=c95c4b4e192d129bb946d83057181005`);
              const geoList = await geoResp.json();
              if (Array.isArray(geoList) && geoList.length > 0) {
                const g = geoList[0];
                // Fetch by coordinates
                const coordResp = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${g.lat}&lon=${g.lon}&appid=c95c4b4e192d129bb946d83057181005&units=metric`);
                data = await coordResp.json();
              }
            } catch (e) {
              console.error('Geocode fallback error', e);
            }
          }

          if (!data || data.cod !== 200) {
            // If single query failed show a helpful message
            if (citiesToFetch.length === 1) {
              const note = document.createElement('div');
              note.className = 'card';
              note.innerHTML = `<p>Could not find weather for "${city}". Please check spelling or try another place.</p>`;
              container.appendChild(note);
            }
            continue; // Skip invalid results
          }

          // Create and append the weather card (show full country name)
          const card = document.createElement('div');
          card.className = 'card';
          const countryFull = getCountryName(data.sys && data.sys.country ? data.sys.country : '');
          card.innerHTML = `
            <h2>${data.name}${countryFull ? ', ' + countryFull : ''}</h2>
            <p>Temperature: ${data.main.temp}°C</p>
            <p>Weather: ${data.weather[0].description}</p>
            <p>Wind Speed: ${data.wind.speed} m/s</p>
          `;
          container.appendChild(card);
        }
      } catch (error) {
        console.error('Error fetching weather data:', error);
        const note = document.createElement('div');
        note.className = 'card';
        note.innerHTML = `<p>Error fetching weather data. Try again later.</p>`;
        container.appendChild(note);
      }
    }

    // Wire up search UI
    const searchBtn = document.getElementById('city-search');
    const clearBtn = document.getElementById('city-clear');
    const cityInput = document.getElementById('city-input');
    const pageTitle = document.getElementById('page-title');
    const suggestionsEl = document.getElementById('suggestions');

    // Debounce helper
    function debounce(fn, wait=300){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }; }

    // Use OpenWeatherMap geocoding API to fetch possible city matches
    async function fetchCitySuggestions(q) {
      if (!q || q.trim().length < 2) { suggestionsEl.style.display = 'none'; suggestionsEl.innerHTML = ''; return; }
      try {
  const url = `https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(q)}&limit=10&appid=c95c4b4e192d129bb946d83057181005`;
        const resp = await fetch(url);
        const list = await resp.json();
        suggestionsEl.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) { suggestionsEl.style.display = 'none'; return; }
        for (let item of list) {
          const countryFull = getCountryName(item.country);
          const label = `${item.name}${item.state ? ', ' + item.state : ''}${countryFull ? ', ' + countryFull : ''}`;
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.textContent = label;
          div.dataset.lat = item.lat;
          div.dataset.lon = item.lon;
          div.addEventListener('click', () => {
            // On select, fetch weather by coordinates
            cityInput.value = label;
            pageTitle.textContent = `Weather for ${label}`;
            suggestionsEl.style.display = 'none';
            fetchWeatherByCoords(item.lat, item.lon, label);
          });
          suggestionsEl.appendChild(div);
        }
        suggestionsEl.style.display = 'block';
      } catch (err) {
        console.error('Suggestion error', err);
        suggestionsEl.style.display = 'none';
      }
    }

    const debouncedSuggestions = debounce(fetchCitySuggestions, 300);

    cityInput.addEventListener('input', (e) => {
      const q = e.target.value;
      debouncedSuggestions(q);
    });

    // Close suggestions when clicking outside
    document.addEventListener('click', (e) => { if (!e.target.closest('.search-bar')) { suggestionsEl.style.display = 'none'; } });

    // Helper: fetch weather by lat/lon
    async function fetchWeatherByCoords(lat, lon, label) {
      const container = document.getElementById('weather-container');
      container.innerHTML = '';
      try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=c95c4b4e192d129bb946d83057181005&units=metric`);
        const data = await response.json();
        if (!data || data.cod !== 200) {
          const note = document.createElement('div');
          note.className = 'card';
          note.innerHTML = `<p>Could not fetch weather for ${label}.</p>`;
          container.appendChild(note);
          return;
        }
        const card = document.createElement('div');
        card.className = 'card';
        const countryFull = getCountryName(data.sys && data.sys.country ? data.sys.country : '');
        card.innerHTML = `
          <h2>${data.name}${countryFull ? ', ' + countryFull : ''}</h2>
          <p>Temperature: ${data.main.temp}°C</p>
          <p>Weather: ${data.weather[0].description}</p>
          <p>Wind Speed: ${data.wind.speed} m/s</p>
        `;
        container.appendChild(card);
      } catch (err) {
        console.error('Coord fetch error', err);
      }
    }

    searchBtn.addEventListener('click', () => {
      const q = cityInput.value.trim();
      if (!q) return;
      pageTitle.textContent = `Weather for ${q}`;
      fetchWeather(q);
    });

    cityInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchBtn.click();
      }
    });

    clearBtn.addEventListener('click', () => {
      cityInput.value = '';
      pageTitle.textContent = 'Current Weather';
      fetchWeather();
    });

    // Initial load: show top cities
    fetchWeather();
    setInterval(() => { if (!cityInput.value.trim()) fetchWeather(); }, 60000); // Refresh top cities when not searching

  </script>
</body>
</html>
